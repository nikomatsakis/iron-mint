#!/bin/bash
# Setup script for Niko's development environment on new machines

set -e

echo "ðŸš€ Setting up Niko's development machine..."

# Detect OS
if [[ "$OSTYPE" == "darwin"* ]]; then
    OS="macos"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    OS="linux"
else
    echo "âŒ Unsupported OS: $OSTYPE"
    exit 1
fi

echo "ðŸ“± Detected OS: $OS"

# Install Nix if not present
if ! command -v nix &> /dev/null; then
    echo "ðŸ“¦ Installing Nix..."
    curl -L https://nixos.org/nix/install | sh
    source ~/.nix-profile/etc/profile.d/nix.sh
else
    echo "âœ… Nix already installed"
    source ~/.nix-profile/etc/profile.d/nix.sh
fi

# Enable flakes
echo "ðŸ”§ Enabling Nix flakes..."
mkdir -p ~/.config/nix
echo "experimental-features = nix-command flakes" > ~/.config/nix/nix.conf

# Clone or update personal dev config
if [ ! -d ~/.config/nix/personal-dev ]; then
    echo "ðŸ“ Cloning personal dev config..."
    git clone git@github.com:nikomatsakis/iron-mint.git ~/.config/nix/personal-dev
else
    echo "ðŸ”„ Updating existing personal dev config..."
    cd ~/.config/nix/personal-dev
    git pull
fi

# Set up dotfiles
if [ -f ~/.config/nix/personal-dev/flake.nix ]; then
    echo "ðŸ  Setting up dotfiles..."
    cd ~/.config/nix/personal-dev
    nix build .#dotfiles
    ./result/bin/setup-dotfiles
fi

# Create dev-env launcher
mkdir -p ~/.local/bin
if [ ! -f ~/.local/bin/dev-env ]; then
    echo "ðŸ”§ Creating dev-env launcher..."
    # The dev-env script would be created here or copied from your config
fi

# Add ~/.local/bin to PATH
if ! echo "$PATH" | grep -q "$HOME/.local/bin"; then
    echo "ðŸ›¤ï¸  Adding ~/.local/bin to PATH..."
    echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
fi

echo "âœ… Development machine setup complete!"
echo "ðŸ”„ Run 'source ~/.bashrc' or start a new shell"
echo "ðŸš€ Then run 'dev-env' to enter your development environment"
